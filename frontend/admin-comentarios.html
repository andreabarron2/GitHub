<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin - Comentarios</title>
  <style>
    body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#eb9ac0,#f3aacb);padding:30px;color:#000}
    h1{color:#000;text-align:center}
  table{width:100%;max-width:1100px;margin:20px auto;border-collapse:collapse;background:#fbd5e5;border-radius:10px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid #f3aacb;text-align:left}
    th{background:#c97aa7;color:#fff}
    tr:hover{background:#fdeaf2}
    button{background:#f3aacb;border:none;border-radius:8px;padding:6px 10px;cursor:pointer}
  .btn-danger{background:#f07a8e;color:#fff}
  .btn-danger:hover{background:#d95f72}
    .leido{opacity:.6}
    .volver{display:inline-block;margin:0 0 10px 5px;color:black;text-decoration:underline;font-weight:bold}
    .summary{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin:10px auto 24px;max-width:1000px}
    .summary-card{flex:1 1 220px;background:#fdeaf2;padding:16px 20px;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,0.12);text-align:center;font-weight:bold;color:#7d4668}
    .summary-card span{display:block;font-size:32px;margin-top:6px;color:#c71585}
    .summary-card.pending span{color:#d1495b}
    .summary-card.read span{color:#2e8b57}
  .search-bar{max-width:600px;margin:0 auto 24px;display:flex;gap:12px;align-items:center;justify-content:center}
  .search-bar input{flex:1 1 auto;padding:10px 14px;border-radius:10px;border:2px solid #f3aacb;background:#fdeaf2;font-size:15px;color:#4a2152}
  .search-bar input:focus{outline:none;border-color:#eb9ac0}
  .search-bar button{padding:10px 18px;border-radius:10px;font-weight:bold}
  .no-results{text-align:center;margin:20px auto;color:#7d4668;font-weight:bold}
  .reply-indicator{display:inline-flex;align-items:center;gap:6px;font-size:13px;padding:4px 8px;border-radius:12px;background:#e8fff2;color:#2e8b57;font-weight:600}
  .reply-indicator.pending{background:#fff4e8;color:#d26b1f}
  .reply-box{margin-top:12px;padding:12px;border-radius:12px;background:#fdeaf2;border:1px solid #f3aacb}
  .reply-box p{margin:8px 0 0;line-height:1.5}
  .reply-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
  .reply-actions button{padding:8px 14px}
  .status-chip{display:inline-block;margin-top:6px;font-size:12px;padding:4px 10px;border-radius:10px;background:#c97aa7;color:#fff;font-weight:bold}
  .status-chip.pending{background:#fff4e8;color:#d26b1f}
    .confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:1000}
    .confirm-overlay[hidden]{display:none!important}
    .confirm-dialog{background:#fff0f7;border-radius:16px;padding:26px 30px;max-width:420px;width:min(100%,420px);box-shadow:0 14px 34px rgba(0,0,0,0.22);text-align:center}
    .confirm-dialog h2{margin:0 0 12px;color:#c71585}
    .confirm-dialog p{margin:0 0 22px;color:#5a2f58}
    .confirm-actions{display:flex;justify-content:center;gap:14px}
    .btn-secondary{background:#fdeaf2;color:#7d4668;border:1px solid #c97aa7}
    .btn-secondary:hover{background:#f3d8e5}
  .reply-dialog{max-width:520px;text-align:left}
  .reply-dialog textarea{width:100%;min-height:140px;border-radius:8px;border:1px solid #c97aa7;padding:12px;background:#fff;color:#4a2152;resize:vertical;font-family:'Segoe UI',sans-serif;font-size:15px}
  .reply-dialog label{display:block;margin-bottom:8px;font-weight:600;color:#7d4668}
  .reply-dialog .confirm-actions{justify-content:flex-end;margin-top:20px}
  </style>
</head>
<body>
  <a class="volver" href="index.html">← Volver al login</a>
  <h1>Comentarios de clientes</h1>
  <div class="summary">
    <div class="summary-card pending">
      Pendientes
      <span id="countPendientes">0</span>
    </div>
    <div class="summary-card read">
      Leídos
      <span id="countLeidos">0</span>
    </div>
  </div>
  <div class="search-bar">
    <input type="search" id="comentarioSearch" placeholder="Buscar por nombre, correo o mensaje..." autocomplete="off">
    <button type="button" id="comentarioClear" class="btn-secondary">Limpiar</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Nombre</th>
        <th>Email</th>
        <th>Mensaje</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <div class="confirm-overlay" id="deleteModal" hidden>
    <div class="confirm-dialog" role="dialog" aria-modal="true" aria-labelledby="deleteTitle">
      <h2 id="deleteTitle">Eliminar comentario</h2>
      <p id="deleteMessage">¿Seguro que deseas eliminar este comentario?</p>
      <div class="confirm-actions">
        <button type="button" class="btn-secondary" id="deleteCancel">Cancelar</button>
        <button type="button" class="btn-danger" id="deleteConfirm">Eliminar</button>
      </div>
    </div>
  </div>
  <div class="confirm-overlay" id="replyModal" hidden>
    <div class="confirm-dialog reply-dialog" role="dialog" aria-modal="true" aria-labelledby="replyTitle">
      <h2 id="replyTitle">Responder comentario</h2>
      <p id="replyContext">Escribe la respuesta que verá el cliente.</p>
      <label for="replyTextarea">Respuesta del administrador</label>
      <textarea id="replyTextarea" placeholder="Escribe tu respuesta..." spellcheck="true"></textarea>
      <div class="confirm-actions">
        <button type="button" class="btn-secondary" id="replyCancel">Cancelar</button>
        <button type="button" id="replySave">Guardar respuesta</button>
      </div>
    </div>
  </div>
  <script src="js/config.js"></script>
  <script>
    const tbody = document.getElementById('tbody');
    const pendientesEl = document.getElementById('countPendientes');
    const leidosEl = document.getElementById('countLeidos');
    const deleteModal = document.getElementById('deleteModal');
    const deleteCancelBtn = document.getElementById('deleteCancel');
    const deleteConfirmBtn = document.getElementById('deleteConfirm');
    const deleteMessage = document.getElementById('deleteMessage');
    const deleteState = { id: null, row: null, button: null };
    const replyModal = document.getElementById('replyModal');
    const replyTextarea = document.getElementById('replyTextarea');
    const replyCancelBtn = document.getElementById('replyCancel');
    const replySaveBtn = document.getElementById('replySave');
    const replyContext = document.getElementById('replyContext');
    const replyState = { id: null, row: null, button: null };
    const searchInput = document.getElementById('comentarioSearch');
    const clearSearchBtn = document.getElementById('comentarioClear');
    let searchDebounce;
    const FORM_SUBMIT_ENDPOINT = 'https://formsubmit.co/ajax/andrea.rodriguez43@uabc.edu.mx';
    const FORM_SUBMIT_CC = ['jazmin.morfin@uabc.edu.mx', 'vallejo.jose@uabc.edu.mx'];

    function clearDeleteState() {
      deleteState.id = null;
      deleteState.row = null;
      deleteState.button = null;
    }

    function closeDeleteModal(focusTarget) {
      deleteModal.setAttribute('hidden', '');
      const target = focusTarget || deleteState.button;
      clearDeleteState();
      target?.focus();
    }

    function clearReplyState() {
      replyState.id = null;
      replyState.row = null;
      replyState.button = null;
      replyTextarea.value = '';
      replySaveBtn.disabled = false;
      replyContext.textContent = 'Escribe la respuesta que verá el cliente.';
    }

    function closeReplyModal(focusTarget) {
      replyModal.setAttribute('hidden', '');
      const target = focusTarget || replyState.button;
      clearReplyState();
      target?.focus();
    }

    async function ensureAdmin() {
      try {
        const res = await fetch(`${window.API_BASE}/me`, { credentials: 'include' });
        if (!res.ok) return false;
        const data = await res.json().catch(() => ({}));
        return !!(data.user && data.user.role === 'admin');
      } catch (err) {
        console.error('Error verificando admin', err);
        return false;
      }
    }

    function renderCounters(totals = {}) {
      const pendientes = Number(totals.noLeidos ?? totals.pendientes ?? 0);
      const leidos = Number(totals.leidos ?? 0);
      pendientesEl.textContent = pendientes;
      leidosEl.textContent = leidos;
    }

    function escapeHtml(str = '') {
      if (str === null || str === undefined) return '';
      return String(str).replace(/[&<>"']/g, (match) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[match] || match);
    }

    function formatMultiline(str = '') {
      return escapeHtml(str).replace(/\r?\n/g, '<br>');
    }

    function formatDate(value) {
      if (!value) return '—';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '—';
      return date.toLocaleString();
    }

    function normalizeComentario(c = {}) {
      const rawCreated = c.created_at ?? c.createdAt ?? '';
      let createdIso = '';
      if (rawCreated) {
        const date = new Date(rawCreated);
        if (!Number.isNaN(date.getTime())) {
          createdIso = date.toISOString();
        }
      }
      const respuesta = typeof c.respuesta_admin === 'string' ? c.respuesta_admin : (c.respuesta || '');
      const mensaje = typeof c.mensaje === 'string' ? c.mensaje : '';
      const respondidoFlag = c.respondido !== undefined ? Boolean(c.respondido) : respuesta.trim().length > 0;
      return {
        id: Number(c.id ?? 0),
        nombre: c.nombre ?? '',
        email: c.email ?? '',
        mensaje,
        respuesta_admin: respuesta,
        respondido: respondidoFlag,
        leido: Boolean(c.leido),
        created_at: createdIso
      };
    }

    function setRowData(tr, data) {
      tr.dataset.id = data.id ? String(data.id) : '';
      tr.dataset.nombre = data.nombre || '';
      tr.dataset.email = data.email || '';
      tr.dataset.mensaje = data.mensaje || '';
      tr.dataset.respuesta = data.respuesta_admin || '';
      tr.dataset.respondido = data.respondido ? '1' : '0';
      tr.dataset.leido = data.leido ? '1' : '0';
      tr.dataset.createdAt = data.created_at || '';
    }

    function comentarioRowTemplate(data) {
      const fecha = formatDate(data.created_at);
      const mensajeHtml = data.mensaje ? formatMultiline(data.mensaje) : '—';
      const respuestaHtml = data.respuesta_admin ? `<div class="reply-box"><strong>Respuesta del administrador</strong><p>${formatMultiline(data.respuesta_admin)}</p></div>` : '';
      const estadoTexto = data.leido ? 'Leído' : 'Pendiente';
      const statusClass = `status-chip${data.respondido ? '' : ' pending'}`;
      const statusText = data.respondido ? 'Respondido' : 'Sin respuesta';
      const replyLabel = data.respondido ? 'Editar respuesta' : 'Responder';
      const markButton = data.leido ? '' : `<button data-action="mark" data-id="${data.id}">Marcar leído</button>`;
      const actionButtons = [
        `<button data-action="reply" data-id="${data.id}">${replyLabel}</button>`,
        markButton,
        `<button class="btn-danger" data-action="delete" data-id="${data.id}">Eliminar</button>`
      ].filter(Boolean).join('');
      return `
        <td>${fecha}</td>
        <td>${escapeHtml(data.nombre)}</td>
        <td>${escapeHtml(data.email)}</td>
        <td>
          <p>${mensajeHtml}</p>
          ${respuestaHtml}
        </td>
        <td>
          <div data-estado>${estadoTexto}</div>
          <div class="${statusClass}" data-status>${statusText}</div>
        </td>
        <td>
          <div class="reply-actions">
            ${actionButtons}
          </div>
        </td>
      `;
    }

    function updateComentarioRow(tr, comentario) {
      const data = normalizeComentario(comentario);
      setRowData(tr, data);
      tr.classList.toggle('leido', data.leido);
      tr.innerHTML = comentarioRowTemplate(data);
      return data;
    }

    function createComentarioRow(comentario) {
      const tr = document.createElement('tr');
      updateComentarioRow(tr, comentario);
      return tr;
    }

    function getRowData(tr) {
      if (!tr) return null;
      return {
        id: Number(tr.dataset.id || 0),
        nombre: tr.dataset.nombre || '',
        email: tr.dataset.email || '',
        mensaje: tr.dataset.mensaje || '',
        respuesta_admin: tr.dataset.respuesta || '',
        respondido: tr.dataset.respondido === '1',
        leido: tr.dataset.leido === '1',
        created_at: tr.dataset.createdAt || ''
      };
    }

    function renderEmptyState(message) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="6" class="no-results">${message}</td>`;
      tbody.appendChild(tr);
    }

    async function notifyComentarioRespuesta(comentario) {
      if (!comentario || !comentario.email) return;
      const respuesta = (comentario.respuesta_admin || '').trim();
      if (!respuesta) return;
      const body = {
        nombre_cliente: comentario.nombre || 'Cliente',
        correo_cliente: comentario.email,
        mensaje_original: comentario.mensaje || '',
        respuesta_admin: respuesta,
        '_subject': `Respuesta a tu comentario - Little Nails Luxury`,
        '_template': 'table',
        '_captcha': 'false',
        '_cc': [...FORM_SUBMIT_CC, comentario.email].join(',')
      };

      try {
        const res = await fetch(FORM_SUBMIT_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(body)
        });
        if (!res.ok) {
          const error = await res.json().catch(() => ({}));
          throw new Error(error.message || 'FormSubmit rechazó la respuesta');
        }
        await res.json().catch(() => ({}));
      } catch (err) {
        console.error('No se pudo enviar la notificación de respuesta', err);
      }
    }

    async function cargar() {
      if (!(await ensureAdmin())) {
        alert('Debes iniciar sesión como admin en Usuarios.html');
        window.location.href = 'Usuarios.html';
        return;
      }

      try {
        const params = new URLSearchParams();
        const term = searchInput?.value.trim();
        if (term) params.append('search', term);
        const queryString = params.toString();
        const res = await fetch(`${window.API_BASE}/admin/comentarios${queryString ? `?${queryString}` : ''}`, { credentials: 'include' });
        if (!res.ok) throw new Error('No autorizado');
        const payload = await res.json();
        const items = Array.isArray(payload) ? payload : (payload.items || []);
        const totals = payload.totals || {
          leidos: items.filter((c) => c.leido).length,
          noLeidos: items.filter((c) => !c.leido).length
        };
        renderCounters(totals);

        tbody.innerHTML = '';
        if (items.length === 0) {
          const emptyMessage = term ? 'Sin resultados para esta búsqueda.' : 'No hay comentarios registrados.';
          renderEmptyState(emptyMessage);
        } else {
          items.forEach((comentario) => {
            tbody.appendChild(createComentarioRow(comentario));
          });
        }
      } catch (error) {
        console.error('Error al cargar comentarios', error);
        tbody.innerHTML = '';
        renderEmptyState('No se pudieron cargar los comentarios.');
        renderCounters({ leidos: 0, noLeidos: 0 });
      }
    }

    tbody.addEventListener('click', async (event) => {
      const btn = event.target.closest('button');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      if (!id || !action) return;

      if (action === 'delete') {
        const row = btn.closest('tr');
        const nombre = row?.dataset?.nombre || 'este comentario';
        deleteState.id = id;
        deleteState.row = row;
        deleteState.button = btn;
        deleteMessage.textContent = `¿Eliminar el comentario enviado por "${nombre}"? Esta acción es permanente.`;
        deleteConfirmBtn.disabled = false;
        deleteModal.removeAttribute('hidden');
        deleteConfirmBtn.focus();
        return;
      }

      if (action === 'mark') {
        btn.disabled = true;
        try {
          const res = await fetch(`${window.API_BASE}/admin/comentarios/${id}/marcar`, {
            method: 'PATCH',
            credentials: 'include'
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            alert(data.error || 'No se pudo actualizar el comentario');
            btn.disabled = false;
            return;
          }
          if (data.totals) renderCounters(data.totals);
          const row = btn.closest('tr');
          const rowData = getRowData(row);
          if (row && rowData) {
            rowData.leido = true;
            updateComentarioRow(row, rowData);
          }
        } catch (err) {
          console.error('Error marcando comentario', err);
          alert('No se pudo marcar el comentario como leído.');
          btn.disabled = false;
          return;
        }
        return;
      }

      if (action === 'reply') {
        const row = btn.closest('tr');
        replyState.id = id;
        replyState.row = row;
        replyState.button = btn;
        replyTextarea.value = row?.dataset?.respuesta || '';
        const nombre = row?.dataset?.nombre || '';
        replyContext.textContent = nombre ? `Responder a ${nombre}` : 'Escribe la respuesta que verá el cliente.';
        replySaveBtn.disabled = false;
        replyModal.removeAttribute('hidden');
        setTimeout(() => {
          replyTextarea.focus();
          const length = replyTextarea.value.length;
          replyTextarea.setSelectionRange(length, length);
        }, 0);
      }
    });

    deleteCancelBtn.addEventListener('click', () => {
      closeDeleteModal();
    });

    deleteModal.addEventListener('click', (event) => {
      if (event.target === deleteModal) {
        closeDeleteModal();
      }
    });

    deleteConfirmBtn.addEventListener('click', async () => {
      if (!deleteState.id) return;
      deleteConfirmBtn.disabled = true;
      try {
        const res = await fetch(`${window.API_BASE}/admin/comentarios/${deleteState.id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          alert(data.error || 'No se pudo eliminar el comentario');
          deleteConfirmBtn.disabled = false;
          return;
        }
        if (data.totals) renderCounters(data.totals);
        deleteState.row?.remove();
        if (!tbody.querySelector('tr')) {
          const term = searchInput?.value.trim();
          const emptyMessage = term ? 'Sin resultados para esta búsqueda.' : 'No hay comentarios registrados.';
          renderEmptyState(emptyMessage);
        }
        closeDeleteModal(searchInput);
      } catch (err) {
        console.error('Error eliminando comentario', err);
        alert('No se pudo eliminar el comentario.');
        deleteConfirmBtn.disabled = false;
      }
    });

    replyCancelBtn.addEventListener('click', () => {
      closeReplyModal();
    });

    replyModal.addEventListener('click', (event) => {
      if (event.target === replyModal) {
        closeReplyModal();
      }
    });

    replySaveBtn.addEventListener('click', async () => {
      if (!replyState.id || !replyState.row) return;
      replySaveBtn.disabled = true;
      const respuesta = replyTextarea.value;
      try {
        const res = await fetch(`${window.API_BASE}/admin/comentarios/${replyState.id}/respuesta`, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ respuesta })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          alert(data.error || 'No se pudo guardar la respuesta');
          replySaveBtn.disabled = false;
          return;
        }
        if (data.totals) renderCounters(data.totals);
        const row = replyState.row;
        if (row) {
          let updatedData;
          if (data.comentario) {
            updatedData = updateComentarioRow(row, data.comentario);
          } else {
            const rowData = getRowData(row) || {};
            rowData.respuesta_admin = respuesta;
            rowData.respondido = respuesta.trim().length > 0;
            rowData.leido = true;
            updatedData = updateComentarioRow(row, rowData);
          }
          notifyComentarioRespuesta(updatedData);
          const newButton = row.querySelector(`button[data-action="reply"][data-id="${replyState.id}"]`);
          closeReplyModal(newButton || searchInput);
        } else {
          if (data.comentario) {
            notifyComentarioRespuesta(normalizeComentario(data.comentario));
          }
          closeReplyModal(searchInput);
        }
      } catch (err) {
        console.error('Error guardando respuesta', err);
        alert('No se pudo guardar la respuesta.');
        replySaveBtn.disabled = false;
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      if (!replyModal.hasAttribute('hidden')) {
        closeReplyModal();
        return;
      }
      if (!deleteModal.hasAttribute('hidden')) {
        closeDeleteModal();
      }
    });

    searchInput?.addEventListener('input', () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => {
        cargar();
      }, 250);
    });

    clearSearchBtn?.addEventListener('click', () => {
      if (!searchInput.value) return;
      searchInput.value = '';
      cargar();
      searchInput.focus();
    });

    cargar();
  </script>
</body>
</html>
